<div class="container product-show-container">
  <%= breadcrumbs ["Produits", products_path], [@product.name, nil] %>

  <div class="row">
    <div class="col-md-8">
      <% if @product.photos.attached? %>
    <!-- Galerie d'images avec Stimulus -->
        <div class="product-gallery" data-controller="product-gallery" data-product-gallery-total-photos-value="<%= @product.photos.count %>">
          <!-- Image principale -->
          <div class="main-image-container">
            <% @product.photos.each_with_index do |photo, index| %>
              <%= cl_image_tag photo.key,
                              quality: :auto,
                              fetch_format: :auto,
                              class: "main-image #{'active' if index == 0}",
                              data: {
                                product_gallery_target: "mainImage",
                                index: index
                              } %>
            <% end %>

            <% if @product.photos.count > 1 %>
              <button class="gallery-nav prev"
                      data-action="click->product-gallery#changePhoto"
                      data-direction="-1">
                <i class="fas fa-chevron-left"></i>
              </button>
              <button class="gallery-nav next"
                      data-action="click->product-gallery#changePhoto"
                      data-direction="1">
                <i class="fas fa-chevron-right"></i>
              </button>
            <% end %>
          </div>

          <!-- Miniatures -->
          <% if @product.photos.count > 1 %>
            <div class="thumbnails-container">
              <% @product.photos.each_with_index do |photo, index| %>
                <div class="thumbnail <%= 'active' if index == 0 %>"
                    data-action="click->product-gallery#showPhoto"
                    data-index="<%= index %>"
                    data-product-gallery-target="thumbnail">
                  <%= cl_image_tag photo.key,
                                  height: 80,
                                  width: 80,
                                  crop: :fill,
                                  quality: :auto %>
                </div>
              <% end %>
            </div>
          <% end %>
        </div>
        <style>
          .product-gallery {
            background: #f8f9fa;
            border-radius: 12px;
            overflow: hidden;
            box-shadow: 0 2px 8px rgba(0, 0, 0, 0.1);
          }

          .main-image-container {
            position: relative;
            height: 500px;
            background: #ffffff;
            display: flex;
            align-items: center;
            justify-content: center;
          }

          .main-image {
            display: none;
            max-height: 500px;
            max-width: 100%;
            object-fit: contain;
          }

          .main-image.active {
            display: block;
          }

          .gallery-nav {
            position: absolute;
            top: 50%;
            transform: translateY(-50%);
            background: rgba(0, 0, 0, 0.5);
            border: none;
            color: white;
            width: 50px;
            height: 50px;
            border-radius: 50%;
            cursor: pointer;
            transition: all 0.3s;
            z-index: 10;
          }

          .gallery-nav:hover {
            background: rgba(0, 0, 0, 0.7);
          }

          .gallery-nav.prev {
            left: 20px;
          }

          .gallery-nav.next {
            right: 20px;
          }

          .thumbnails-container {
            display: flex;
            gap: 10px;
            padding: 15px;
            overflow-x: auto;
          }

          .thumbnail {
            min-width: 80px;
            height: 80px;
            border: 3px solid transparent;
            border-radius: 8px;
            overflow: hidden;
            cursor: pointer;
            transition: all 0.3s;
          }

          .thumbnail:hover {
            border-color: #75DDDD;
            transform: translateY(-2px);
          }

          .thumbnail.active {
            border-color: #508991;
          }

          .thumbnail img {
            width: 100%;
            height: 100%;
            object-fit: cover;
          }

          @media (max-width: 768px) {
            .main-image-container {
              height: 300px;
            }
            .main-image {
              max-height: 300px;
            }
          }
        </style>

      <% else %>
        <div class="placeholder-image-large">
          <i class="fas fa-image"></i>
          <p>Aucune photo</p>
        </div>
      <% end %>
    </div>

    <div class="col-md-4">
      <h1><%= @product.name %></h1>
      <h2 class="text-primary"><%= number_to_currency(@product.price, unit: '€', format: '%n %u') %></h2>
      <p class="text-muted"><i class="fas fa-eye"></i> <%= @product.views_count %> vues</p>
      <p class="mt-3"><%= @product.description %></p>

      <!-- Carte vendeur -->
      <div class="card mt-4 mb-4">
        <div class="card-body">
          <h5 class="card-title mb-3">
            <i class="fas fa-user-circle"></i> Informations vendeur
          </h5>
          <div class="d-flex align-items-center mb-3">
            <i class="fas fa-user-circle fa-3x text-primary me-3"></i>
            <div>
              <strong><%= @product.user.email.split('@').first.capitalize %></strong>
              <% if @product.user.updated_at > 24.hours.ago %>
                <span class="badge bg-success d-block mt-1">
                  <i class="fas fa-circle" style="font-size: 8px;"></i> En ligne récemment
                </span>
              <% elsif @product.user.updated_at > 7.days.ago %>
                <span class="badge bg-warning d-block mt-1">
                  <i class="fas fa-circle" style="font-size: 8px;"></i> Actif cette semaine
                </span>
              <% end %>
            </div>
          </div>

          <p class="text-muted small mb-2">
            <i class="fas fa-calendar-alt"></i>
            Membre depuis <%= @product.user.created_at.strftime("%B %Y") %>
          </p>

          <p class="text-muted small mb-3">
            <i class="fas fa-box"></i>
            <%= @product.user.products.count %> produit<%= 's' if @product.user.products.count > 1 %> en vente
          </p>

          <%= link_to user_path(@product.user), class: "btn btn-outline-primary btn-sm w-100" do %>
            <i class="fas fa-store"></i> Voir tous ses produits
          <% end %>
        </div>
      </div>

      <% if @product.sold %>
        <div class="alert alert-danger">
          <i class="fas fa-info-circle"></i> Ce produit est déjà vendu
        </div>
      <% elsif user_signed_in? && @product.user != current_user %>
      <%= form_with url: product_checkouts_path(@product),
                    method: :post,
                    data: { turbo: false } do |f| %>
        <%= f.submit "Acheter maintenant", class: "btn btn-primary btn-lg w-100" %>
      <% end %>
      <% elsif user_signed_in? && @product.user == current_user %>
        <div class="alert alert-info">
          <i class="fas fa-info-circle"></i> C'est votre produit
        </div>
        <%= link_to "Modifier", edit_product_path(@product), class: "btn btn-warning w-100 mb-2" %>
        <%= button_to "Supprimer",
                      product_path(@product),
                      method: :delete,
                      class: "btn btn-danger w-100",
                      form: { data: { turbo_confirm: "Êtes-vous sûr de vouloir supprimer ce produit ?" } } %>
      <% else %>
        <%= link_to "Connectez-vous pour acheter", new_user_session_path, class: "btn btn-primary btn-lg w-100" %>
      <% end %>
    </div>
  </div>

  <!-- Produits similaires -->
  <% if @similar_products.any? %>
    <div class="mt-5">
      <h3 class="mb-4">Produits similaires</h3>
      <div class="row">
        <% @similar_products.each do |similar_product| %>
          <div class="col-md-3 mb-4">
            <%= render partial: 'shared/product_card', locals: { product: similar_product } %>
          </div>
        <% end %>
      </div>
    </div>
  <% end %>
</div>
