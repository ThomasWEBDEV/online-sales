<div class="banner" style="background-image: linear-gradient(rgba(0,0,0,0.4),rgba(0,0,0,0.4)), url('https://picsum.photos/1200/400?shop');">
  <div class="container">
    <h1>Marketplace</h1>
    <p>Achetez et vendez en toute simplicité</p>
    <% if user_signed_in? && policy(Product).new? %>
      <%= link_to "Mettre en vente", new_product_path, class: "btn btn-flat" %>
    <% end %>
  </div>
</div>

<div class="container mt-4 mb-3">
  <%= form_with url: products_path, method: :get, class: "d-flex" do |f| %>
    <%= f.text_field :query,
                     value: params[:query],
                     placeholder: "Rechercher un produit...",
                     class: "form-control me-2" %>
    <%= f.submit "Rechercher", class: "btn btn-flat" %>
    <% if params[:query].present? %>
      <%= link_to "✕ Effacer", products_path, class: "btn btn-outline-secondary ms-2" %>
    <% end %>
  <% end %>
</div>

<div class="container mb-3">
  <div class="d-flex justify-content-between align-items-center">
    <div class="btn-group" role="group">
      <%= link_to "Plus récents", products_path(query: params[:query], sort: nil),
                  class: "btn btn-outline-secondary #{'active' unless params[:sort]}" %>
      <%= link_to "Prix croissant", products_path(query: params[:query], sort: 'price_asc'),
                  class: "btn btn-outline-secondary #{'active' if params[:sort] == 'price_asc'}" %>
      <%= link_to "Prix décroissant", products_path(query: params[:query], sort: 'price_desc'),
                  class: "btn btn-outline-secondary #{'active' if params[:sort] == 'price_desc'}" %>
      <%= link_to "Populaires", products_path(query: params[:query], sort: 'popular'),
                  class: "btn btn-outline-secondary #{'active' if params[:sort] == 'popular'}" %>
    </div>
    <span class="text-muted">
      <i class="fas fa-shopping-bag"></i>
      <%= @products.count %> produit<%= 's' if @products.count > 1 %>
      <% if @products.where(sold: false).any? %>
        · <%= @products.where(sold: false).count %> disponible<%= 's' if @products.where(sold: false).count > 1 %>
      <% end %>
    </span>
  </div>
</div>

<div class="container mt-4">
  <div class="cards">
    <% @products.each do |product| %>
      <div class="card-product">
        <% if product.photo.attached? %>
          <%= cl_image_tag product.photo.key, height: 150, width: 200, crop: :fill %>
        <% else %>
          <%= image_tag "https://picsum.photos/seed/#{product.id}/200/150" %>
        <% end %>
        <div class="card-product-infos">
          <h2><%= link_to product.name, product, class: "text-decoration-none" %></h2>
          <p>
            <% if product.sold %>
              <span class="badge bg-danger">Vendu</span>
            <% elsif product.created_at > 7.days.ago %>
              <span class="badge bg-success">Nouveau</span>
            <% end %>
            <%= product.description.truncate(80) %>
          </p>
          <p class="text-primary fw-bold"><%= product.price %>€</p>
        </div>
      </div>
    <% end %>
  </div>
</div>
